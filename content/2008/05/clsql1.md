Title: CLSQL実験(1)
Date: 2008-05-02 06:50:00
Category: 
Tags: SQLite3, CLSQL
Slug: clsql1

<p>SQLite3を使ったCLSQLの実験。買い物を整理するデータベースのつもり。クラスを定義する</p><br /><pre><br />(clsql:def-view-class Kaimono ()<br />             ((id :accessor id-of :db-kind :key :db-constraints :not-null :type integer :initarg :id)<br />              (cost :accessor cost-of :type integer :initarg :cost)<br />             ;; (date :accessor date-of :type clsql:date :initarg :date) ;; SQLite3 はDATE型がない!!<br />              (date :accessor date-of :type clsql:date :db-type "integer" :initarg :date ;; INTEGERで保存して、DATE(MJD)に変換する<br />                    :db-writer clsql:date-mjd ;; #'は付けてはいけない!!<br />                    :db-reader mjd-to-date) ;; これは自前で定義<br />              (shop-id :type integer :initarg :shop-id)<br />              (shop :accessor shop-of :db-kind :join<br />                    :db-info (:join-class Shop :home-key shop-id :foreign-key id :set nil)))<br />             (:base-table Kaimonos))<br />(clsql:def-view-class Shop ()<br />             ((id :accessor id-of :db-kind :key :db-constraints :not-null :type integer :initarg :id)<br />              (kaimonos :db-kind :join<br />                        :db-info (:join-class Kaimono :home-key id :foreign-key shop-id :set nil))<br />              (name :accessor name-of :type (string 64) :initarg :name))<br />             (:base-table Shops))<br /><br />(defun mjd-to-date (mjd)<br />  (gregorian-to-date (clsql:mjd-to-gregorian mjd)))<br /></pre><br /><p>クラスKaimono, Shopを定義し、Kaimonos, Shopsテーブルにマップする。苦戦したのが、Kaimonoのdateスロット。SQLite3は日付型が無いので、とりあえず数値として日付を保存することにした。で、dateスロット自体は、CLSQL:DATE型とする。DBに書き込む/から読み出すときに、数値<->オブジェクトの変換を行う。そのために、db-writer, db-readerを使う。コメントにも書いたが、使用する関数には#'を付けてはいけないらしい(CL初心者...)。</p><br /><p>なんとかオブジェクトで出し入れができるようになってきた。</p>
