Title: SolrをJSONで使うときにはまったことのメモ
Date: 2011-09-17 12:06:00
Category: 
Tags: Web,Programming,Solr,Lisp
Slug: solrjson

<a href="http://lucene.apache.org/solr/">Apache Solr</a>の検索機能を試してみた。自作Lispアプリから<a href="http://weitz.de/drakma/">drakma</a>を使用してJSONによりデータを追加しようとした。<br /><br /><b>結論からすると、Solrは、JSONの文字列は、シングルクオートではなく、ダブルクオートでないとエラーになる。</b><br /><b><br /></b><br />自分の調べた範囲では、JSONとしてはシングルクオートでもダブルクオートでも文字列としてvalidである(らしい)ので、これはSolr側の問題であると思う。<br /><b><br /></b><br /><a href="http://common-lisp.net/project/parenscript/">Parenscript</a>を使用して文字列を作ると、シングルクオートで囲われてしまう。代わりに、<a href="http://common-lisp.net/project/cl-json/">CL-JSON</a>を使用することにした。こちらはなかなか使い方が難しかったが、<br /><br /><br />(defun get-insert-answer-json (id uid qid ans)<br />&nbsp; (with-output-to-string (stream)<br />&nbsp; &nbsp; &nbsp;(json:with-object (stream)<br />&nbsp; &nbsp; &nbsp; &nbsp;(json:as-object-member (:add stream)<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> (json:with-object (stream)<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> &nbsp; (json:encode-object-member "doc"<br /><span class="Apple-tab-span" style="white-space: pre;">    </span> &nbsp; &nbsp; &nbsp;`((id . ,id) (uid_i . ,uid) (tp_i . 2) (qid_i . ,qid) (a_t . ,ans))<br /><span class="Apple-tab-span" style="white-space: pre;">    </span> &nbsp; &nbsp; &nbsp;stream))))))<br /><br />こんな感じで、Solrに追加するJSON文字列を作ることができた。REPLから<br />(get-insert-answer-json 1 3 4 "hogebar")<br />とすると、<br />"{\"add\":{\"doc\":{\"id\":1,\"uid_i\":3,\"tp_i\":2,\"qid_i\":4,\"a_t\":\"hogebar\"}}}"<br />と出力される。これでOK。
