Title: MySQL + cl-mysql によるPrepared Statement
Date: 2011-05-30 14:14:00
Category: 
Tags: Programming,Lisp
Slug: mysql-cl-mysql-prepared-statement

あまり詳しく調査はしていないが、clsqlでもMySQLでのPrepared Statementはそれほどうまく動作しないらしい。それで、cl-mysqlでもできないか調べてみた。<br /><br />Prepared Statementには2種類の実装方法がある。動的、静的とそれぞれ呼ばれている。最近のMySQLは静的Prepared Statementを実装している。<a href="http://dev.mysql.com/doc/refman/5.0/en/sql-syntax-prepared-statements.html">ここ</a>を参照。それでPrepared StatementでSQLを実行し、結果を返す関数は次のように実装できた。<br /><br /><br />(defun with-prepared-statement (st &amp;rest arg)<br />&nbsp; (cl-mysql:query (format nil "PREPARE stmt1 FROM '~a';" st))<br />&nbsp; (let ((syms (loop for x from 1 to (length arg)<br /><span class="Apple-tab-span" style="white-space: pre;">  </span> for sym = (gensym)<br /><span class="Apple-tab-span" style="white-space: pre;">  </span> collect sym)))<br />&nbsp; &nbsp; (loop for param in syms<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> for i from 0<br />&nbsp; &nbsp; &nbsp; &nbsp;for set = (format nil "SET @~a = ~s;" param (nth i arg))<br />&nbsp; &nbsp; &nbsp; &nbsp;do (cl-mysql:query set))<br />&nbsp; &nbsp; (let ((result<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> &nbsp; (cl-mysql:query (format nil "EXECUTE stmt1 USING ~{@~a~^, ~};" syms))))<br />&nbsp; &nbsp; &nbsp; (cl-mysql:query "DEALLOCATE PREPARE stmt1;")<br />&nbsp; &nbsp; &nbsp; result)))<br /><br />あまりloop, formatの使い方に慣れていないので、とりあえず動いたというレベル。PREPARE, SET, EXECUTE, DEALLOCATEを順番に実行し、EXECUTEの結果を返す。<br /><br />上記で確かにPrepared Statementとして動作はするのだが、自分の希望としては、これによってSQLインジェクション対策をしたかった。しかしながら、これでは完全な対策にはならなさそうである。これは単にPrepared Statementであって、何度も同じクエリをパラメタを変えて実行するには使えるが、パラメタ部分のサニタイズはされない。例えば、SET @hoge=(パラメタ)としているところで、"1; delete from tbl;"と入力されてしまうと、SETの次の文でtblからデータが消されてしまう。これを防ぐには、SETで文が意図せず終了されないように気をつけないといけない。
