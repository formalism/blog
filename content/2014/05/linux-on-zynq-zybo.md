Title: Linux on Zynq (ZYBO)
Date: 2014-05-06 09:39:00
Category: 
Tags: Zynq,Linux,FPGA
Slug: linux-on-zynq-zybo

今度はZYBOにてLinuxを動作させてみようと挑戦した備忘録。<br /><br />まとまった情報がなかなか見つからなくて苦労したが、基本はMasahiro Yamadaさんの、"<a href="http://masahir0y.blogspot.jp/2014/01/u-boot-linux-kernel-zynq.html">U-Boot と Linux Kernel のメインラインで Zynq を動かす</a>"を参考にした。<br /><br />STEP0: DTCの準備 はそのまま実施した。<br /><br />STEP1: U-Bootのビルド ではまった。結論としては、ARMのクロスコンパイラとして<a href="http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/">CodeSourcery Lite</a>を使用した(単にXilinxからgccをダウンロードするのが面倒だったので。Xilinxのgccで動くかは試していないため不明)。<br /><br />最初は<a href="http://www.linaro.org/downloads/">LinaroのGCC</a>でU-Bootをビルドしていたが、どうしても動作しなかった。U-Bootはlibcにも依存しているようで、LinaroのGCCだとダメだと思われる。<br /><br />さらに、肝心のU-Bootは、オリジナルのものだと動かなかったので、<a href="https://github.com/Digilent/u-boot-Digilent-Dev">DigilentのU-Boot</a>を使用した。この手順は、Ryuzさんの"<a href="http://ryuz.txt-nifty.com/blog/2014/04/zybozynqu-boot-.html">ZYBO(Zynq)のu-bootのビルドまで</a>"に従った。CROSS_COMPILEのところは、(CodeSourceryなので)arm-none-eabi-にした。makeでu-boot.binができた(上記手順だとDTBはできないが、Linuxのブートは可能)。<br /><br />STEP2: Linux Kernelのビルド には、<a href="http://www.linaro.org/downloads/">Linaroのgcc</a>を使用した。 <br />gcc-linaro-arm-linux-gnueabihf-4.8-2014.04_linux.tar.xzを解凍して使用した。CodeSourceryでも可能かは試していないため不明だが、linuxのカーネル自体はlibcに依存していないらしいので、可能かも知れない。<br /><br />git cloneしてgit checkout v3.14。arch/arm/boot/dts/zynq-7000.dtsiを直接編集し、ps-clk-frequency=&lt;50000000&gt;してからmake。<br /><br />STEP3, STEP4はほぼ同様だが、fit.itsにおいて、fdt@1のセクションでzynq-zc706.dtbをzynq-zed.dtbに変更した。<br /><br />これでSTEP5の手順にてLinuxのブートまで確認できた。ただし、dow -data u-boot-dtb.binの代わりに、dow -data u-boot.binとした。<br /><br />ただ、これだとDTBが正しくない?のか、Ethernetが使えない。これについては現在調査中。<br /><br /><b>2014/5/8追記：</b><br />Ethernetを使えるようにするために、純正カーネルではなく、別のところからカーネルを持ってきた。<br /><br /><a href="http://www.wiki.xilinx.com/Fetch+Sources">こちら</a>にある、linux-xlnx.git(Xilinx純正gitレポジトリ)をcloneして、 xilinx-v2014.1をcheckout。こちらもarch/arm/boot/dts/zynq-zed.dtsを編集して、ps-clk-frequencyを50MHzにした(ZedBoardのdtbを使った)。次に、<a href="http://www.wiki.xilinx.com/Build+Kernel">こちらのページ</a>に従い、<br />make ARCH=arm xilinx_zynq_defconfig<br />make ARCH=arm menuconfig<br />make ARCH=arm CROSS_COMPILE=arm-none-eabi-<br />と実行。後は、fit.itsのkernel@1ノードとfdt@1ノードのdataプロパティを、それぞれ<br />data = /incbin/("linux-xlnx/arch/arm/boot/zImage"), data=/incbin/("linux-xlnx/arch/arm/boot/dts/zynq-zed.dtb")とした。再度mkimageしたバイナリで起動したら、Ethernetが認識できるようになった。<br /><br />
