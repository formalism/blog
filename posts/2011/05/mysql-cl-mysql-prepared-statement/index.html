<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>思いつきメモ</title>
	<meta name="description" content="">
	<meta name="author" content="tu1978">

	<!-- HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://formalism.github.io/blog/theme/html5.js"></script>
	<![endif]-->

	<!-- Styles -->
	<link href="https://formalism.github.io/blog/theme/bootstrap.min.css" rel="stylesheet">
	<link href="https://formalism.github.io/blog/theme/local.css" rel="stylesheet">
	<link href="https://formalism.github.io/blog/theme/pygments.css" rel="stylesheet">

	<!-- Feeds -->




</head>
<body>
	<div class="topbar">
	  <div class="topbar-inner">
		<div class="container-fluid">
		  <a class="brand" href="https://formalism.github.io/blog/">思いつきメモ</a>
			<ul class="nav">
					<li class="active"><a href="https://formalism.github.io/blog/category/.html"></a></li>
			</ul>
			<p class="pull-right"><a href="https://formalism.github.io/blog/archives.html">[archives]</a> <a href="https://formalism.github.io/blog/tags.html">[tags]</a></p>
		</div>
	  </div>
	</div>

	<div class="container-fluid">
	  <div class="sidebar">
		<div class="well">
			<div class="social">
			<h3>Social</h3>
			<ul>
				<li><a href="http://twitter.com/tu1978">twitter</a></li>
			</ul>
			</div>
			<h3>Tags</h3>
			<ul>
			  <li><a href="https://formalism.github.io/blog/tag/agda.html">Agda (3)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/android.html">Android (4)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/blogging.html">Blogging (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/c.html">C# (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/c-amp.html">C++ AMP (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/center-exam.html">Center Exam (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/clojure.html">clojure (2)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/clsql.html">CLSQL (2)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/fpga.html">FPGA (20)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/gadgets.html">Gadgets (6)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/haskell.html">Haskell (5)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/linux.html">Linux (7)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/liquor.html">Liquor (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/lisp.html">Lisp (3)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/mac.html">Mac (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/math.html">Math (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/opencl.html">OpenCL (3)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/opensolaris.html">OpenSolaris (3)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/pc.html">PC (4)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/printer.html">Printer (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/progra.html">Progra (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/programming.html">Programming (49)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/shu-ping.html">書評 (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/software.html">Software (2)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/solr.html">Solr (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/sqlite3.html">SQLite3 (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/starbucks.html">Starbucks (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/tcf.html">TCF (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/uncategorized.html">Uncategorized (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/web.html">Web (2)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/wi2.html">Wi2 (2)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/windows.html">Windows (1)</a></li>
			  <li><a href="https://formalism.github.io/blog/tag/zynq.html">Zynq (9)</a></li>
			</ul>
		</div>
	  </div>
	  <div class="content">
	<div class='article'>
		<div class="page-header"><h1>MySQL + cl-mysql によるPrepared Statement</h1></div>
		<div class="well small">Permalink: <a class="more" href="https://formalism.github.io/blog/posts/2011/05/mysql-cl-mysql-prepared-statement/">2011-05-30 14:14:00+09:00</a>
by <a class="url fn" href="https://formalism.github.io/blog/author/tu1978.html">tu1978 </a>
 in <a href="https://formalism.github.io/blog/category/.html"></a>
tags: <a href="https://formalism.github.io/blog/tag/programming.html">Programming</a> <a href="https://formalism.github.io/blog/tag/lisp.html">Lisp</a> </div>
		<div><p>あまり詳しく調査はしていないが、clsqlでもMySQLでのPrepared Statementはそれほどうまく動作しないらしい。それで、cl-mysqlでもできないか調べてみた。<br /><br />Prepared Statementには2種類の実装方法がある。動的、静的とそれぞれ呼ばれている。最近のMySQLは静的Prepared Statementを実装している。<a href="http://dev.mysql.com/doc/refman/5.0/en/sql-syntax-prepared-statements.html">ここ</a>を参照。それでPrepared StatementでSQLを実行し、結果を返す関数は次のように実装できた。<br /><br /><br />(defun with-prepared-statement (st &amp;rest arg)<br />&nbsp; (cl-mysql:query (format nil "PREPARE stmt1 FROM '~a';" st))<br />&nbsp; (let ((syms (loop for x from 1 to (length arg)<br /><span class="Apple-tab-span" style="white-space: pre;">  </span> for sym = (gensym)<br /><span class="Apple-tab-span" style="white-space: pre;">  </span> collect sym)))<br />&nbsp; &nbsp; (loop for param in syms<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> for i from 0<br />&nbsp; &nbsp; &nbsp; &nbsp;for set = (format nil "SET @~a = ~s;" param (nth i arg))<br />&nbsp; &nbsp; &nbsp; &nbsp;do (cl-mysql:query set))<br />&nbsp; &nbsp; (let ((result<br /><span class="Apple-tab-span" style="white-space: pre;"> </span> &nbsp; (cl-mysql:query (format nil "EXECUTE stmt1 USING ~{@~a~^, ~};" syms))))<br />&nbsp; &nbsp; &nbsp; (cl-mysql:query "DEALLOCATE PREPARE stmt1;")<br />&nbsp; &nbsp; &nbsp; result)))<br /><br />あまりloop, formatの使い方に慣れていないので、とりあえず動いたというレベル。PREPARE, SET, EXECUTE, DEALLOCATEを順番に実行し、EXECUTEの結果を返す。<br /><br />上記で確かにPrepared Statementとして動作はするのだが、自分の希望としては、これによってSQLインジェクション対策をしたかった。しかしながら、これでは完全な対策にはならなさそうである。これは単にPrepared Statementであって、何度も同じクエリをパラメタを変えて実行するには使えるが、パラメタ部分のサニタイズはされない。例えば、SET @hoge=(パラメタ)としているところで、"1; delete from tbl;"と入力されてしまうと、SETの次の文でtblからデータが消されてしまう。これを防ぐには、SETで文が意図せず終了されないように気をつけないといけない。</p></div>
		<div>
			<h2>Comments</h2>
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="@tu1978">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
		<div>
	</div>
		<footer>
		  <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme based on <a href="http://twitter.github.com/bootstrap/">Twitter Bootstrap</a>.</p>
		  <p>&copy; tu1978</p>
		</footer>
	  </div>

	</div>
</body>
</html>